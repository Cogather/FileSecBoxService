# FileSecBoxService 设计文档

## 1. 整体架构
FileSecBoxService 是一个基于应用（Agent）维度隔离的安全沙箱服务。为了支持“基线技能”与“个人调测工作区”的分离，系统引入了多租户（User）隔离机制。应用管理员通过上传维护基线，而普通用户在独立的临时工作区中进行同步、调测与修改。

---

## 2. 存储设计

### 2.1 物理目录布局
所有数据均存储在统一的产品根目录下（`${app.product.root}`），通过多级目录实现基线与用户工作区的隔离。

| 区域 | 物理存储路径 | 说明 |
| :--- | :--- | :--- |
| **基线区 (Baseline)** | `${app.product.root}/{agentId}/baseline/` | 存放应用的官方/原始技能及文件。任何上传操作均默认写入此目录。 |
| **租户区 (Workspaces)** | `${app.product.root}/{agentId}/workspaces/{userId}/` | **全员隔离工作区**。无论何种身份的用户，所有查询、执行、修改等操作均在此临时目录下生效。 |
| **元数据 (Meta)** | `${app.product.root}/{agentId}/workspaces/{userId}/.meta/` | 记录每个技能的同步时间戳及状态，用于与基线进行比对。 |
| **全局工具 (Tools)** | `${app.product.root}/skill-creator/` | 存放全局统一的 Skill-Creator 工具包，不随用户隔离。 |

### 2.2 工作区同步逻辑 (On-demand Sync)
*   **触发机制**：当用户首次发起请求（或工作区被清理后再次访问）时，系统自动检查租户区是否存在。
*   **同步动作**：若不存在，系统会将 `baseline/` 目录下的内容全量拷贝至 `workspaces/{userId}/`。
*   **初始标记**：同步完成后，在 `.meta/` 下记录当前同步的基线版本或时间戳。

### 2.3 路径校验与重定向
*   **路径屏蔽**：API 接收逻辑路径（如 `skills/A/main.py`），底层自动解析为物理工作区路径。
*   **Skill-Creator 特殊处理**：如果逻辑路径涉及 `skill-creator`，系统强制重定向到全局工具目录，**屏蔽**掉用户目录下的同名干扰，确保工具版本统一且不占用用户存储。
*   **安全锚定**：物理路径必须锚定在对应的 `workspaces/{userId}/` 范围内，严禁跨用户或跨应用访问。

---

## 3. 技能管理与基线化

### 3.1 技能状态识别
系统通过比对用户工作区与基线区的元数据，为每个技能定义以下状态：
*   **`UNCHANGED` (已同步)**：用户技能与基线一致（根据 `mtime` 和 `.meta` 记录比对）。
*   **`MODIFIED` (已修改)**：用户在工作区修改了技能，尚未同步至基线。
*   **`NEW` (新增)**：用户在工作区创建了基线中不存在的技能。
*   **`OUT_OF_SYNC` (基线已更新)**：基线技能有了新版本，用户当前持有的是旧版本。

### 3.2 技能维度的“基线化” (Baselining)
*   **操作定义**：允许应用管理员将某个处于 `MODIFIED` 或 `NEW` 状态的技能从其个人工作区推送到应用基线。
*   **原子性覆盖**：操作仅针对特定技能文件夹，将 `workspaces/{userId}/skills/{skillName}` 的内容递归覆盖至 `baseline/skills/{skillName}`。
*   **全局同步感应**：基线更新后，其他用户的该技能状态会自动变为 `OUT_OF_SYNC`。

### 3.3 技能周期管理
*   **上传 (Upload)**：默认上传至基线目录。
*   **查询 (List)**：返回当前用户工作区下的技能列表。系统会自动解析 `SKILL.md` 提取元数据。
*   **冗余层级压缩**：在列表显示前自动打平 `skills/A/A/` 等异常结构。

---

## 4. 执行引擎与安全

### 4.1 指令执行上下文
*   **工作目录**：固定为用户的 `workspaces/{userId}/`。
*   **Shell 包装与白名单**：保持原有的 `bash -c` 包装及严格的指令白名单。
*   **SKILL.md 保护**：严禁在技能根目录以外的位置操作 `SKILL.md`。

### 4.2 用户目录清理 (Cleanup)
*   **策略**：闲置存活制 (TTL)。
*   **执行**：定时任务（每小时）扫描 `workspaces/`。若某个 `userId` 目录下的文件最后访问时间超过 **24小时**，则自动删除该用户目录以释放空间。

---

## 5. 并发锁管理
*   **锁粒度**：维持 `agentId` 级别的 `ReentrantReadWriteLock`。虽然增加了 `userId`，但为保证基线同步的一致性，按应用维度加锁是最稳健的方案。

---

## 6. 技术栈
*   **JDK 8 版本**: 适配 Spring Boot 2.3.12.RELEASE, 使用 `javax.servlet`。
*   **JDK 21 版本**: 适配 Spring Boot 3.x, 使用 `jakarta.servlet`。
*   **存储**: 本地文件系统。
*   **并发控制**: 基于 `ReentrantReadWriteLock` 的应用级锁。
